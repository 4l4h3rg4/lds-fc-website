---
import Layout from "../layouts/Layout.astro";
import { ArrowRight, Zap, Shield, Globe } from "lucide-react";
import MatchCard from "../components/home/MatchCard.astro";
import QuoteSection from "../components/home/QuoteSection.astro";
import HomeManifesto from "../components/home/HomeManifesto.astro";
import HomeSquad from "../components/home/HomeSquad.astro";
import HomeTraining from "../components/home/HomeTraining.astro";
import HomeCommunity from "../components/home/HomeCommunity.astro";
import HomeStore from "../components/home/HomeStore.astro";
import HomeContact from "../components/home/HomeContact.astro";
import Footer from "../components/shared/Footer.astro";
import { supabase } from "../lib/supabase";

// 1. Fetch Players (Limit 3 for display)
const { data: playersData } = await supabase
	.from("players")
	.select("*")
	.limit(3);
const players = playersData || [];

// 2. Fetch Products (Limit 3, with badges)
const { data: productsData } = await supabase
	.from("products")
	.select("*, badge:badges(text, color)")
	.limit(3);
const products = (productsData || []).map((p: any) => ({
	...p,
	badge: p.badge, // Ensure badge structure matches
}));

// 3. Fetch Featured Story (Limit 1)
const { data: storiesData } = await supabase
	.from("stories")
	.select("*")
	.limit(1);
const featuredStory =
	storiesData && storiesData.length > 0 ? storiesData[0] : null;

// 4. Fetch Matches (Next and Last)
const { data: matchesData } = await supabase
	.from("matches")
	.select(
		`
        *,
        match_players (
            is_starter,
            goals,
            player:players (name)
        )
    `,
	)
	.order("created_at", { ascending: false }); // Assuming created_at helps or parsed date

const allMatches = (matchesData || []).map((m: any) => {
	// Transform match_players logic (same as partidos.astro)
	const starters: any[] = [];
	const bench: any[] = [];
	if (m.match_players) {
		m.match_players.forEach((mp: any) => {
			const playerObj = {
				name: mp.player.name,
				goals: mp.goals > 0 ? mp.goals : undefined,
			};
			if (mp.is_starter) starters.push(playerObj);
			else bench.push(playerObj);
		});
	}
	return { ...m, squad: { starters, bench } };
});

const nextMatch = allMatches.find((m: any) => m.status === "NEXT");
const lastMatch = allMatches.find((m: any) => m.status !== "NEXT"); // Simplification for now
---

<Layout title="LDS FC | El Rugido">
	<main class="w-full relative">
		<!-- Hero Section -->
		<div
			class="relative w-full h-screen flex flex-col justify-center items-center overflow-hidden"
		>
			<!-- Background Image -->
			<div class="absolute inset-0 z-0">
				<img
					src="/bg-hero.png"
					alt="Hero Background"
					class="w-full h-full object-cover opacity-80"
				/>
				<div class="absolute inset-0 bg-black/60"></div>
			</div>

			<!-- Content Z-Index -->
			<div
				class="relative z-10 flex flex-col items-center justify-center -mt-20"
			>
				<!-- Logo -->
				<img
					src="/logo LDS FC.png"
					alt="LDS FC Logo"
					class="h-24 md:h-32 mb-8 drop-shadow-[0_0_15px_rgba(34,211,238,0.3)]"
				/>

				<!-- Main Title with Glow and Sticker -->
				<div class="relative mb-6 text-center">
					<h1
						class="font-graffiti text-[120px] md:text-[180px] leading-[0.8] tracking-normal text-white drop-shadow-[5px_5px_0px_rgba(0,0,0,0.5)] transform -rotate-2 mix-blend-normal opacity-100"
					>
						L.D.S FC
					</h1>
				</div>

				<!-- Subtext with bullets -->
				<div
					class="flex items-center gap-4 text-[var(--color-neon-cyan)] uppercase tracking-[0.5em] md:tracking-[0.8em] font-light text-xs md:text-sm mb-12"
				>
					<span>El que abandona pierde</span>
				</div>

				<!-- Buttons -->
				<div class="flex flex-col md:flex-row gap-6">
					<a
						href="#plantel"
						class="px-8 py-3 bg-white text-black font-heading uppercase tracking-widest text-sm hover:scale-105 transition-transform"
					>
						La Familia
					</a>
					<a
						href="#partidos"
						class="px-8 py-3 bg-black text-white border border-white font-heading uppercase tracking-widest text-sm hover:bg-white hover:text-black transition-colors"
					>
						La Fecha
					</a>
				</div>
			</div>

			<!-- Bottom Banner (Scrolling) -->
			<div
				class="absolute bottom-0 w-full bg-[var(--color-neon-cyan)] text-black py-2 overflow-hidden border-t-2 border-black z-30"
			>
				<div
					class="animate-marquee whitespace-nowrap flex gap-12 font-heading uppercase tracking-widest text-sm font-bold"
				>
					<!-- Content duplicated for seamless loop -->
					<span
						>+++ EL QUE ABANDONA PIERDE +++ NACIDOS EN EL BARRO +++
						UN CÍRCULO QUE NO SE ROMPE +++ MÁS QUE LOS MINUTOS +++
						SUDOR Y GLORIA +++ LA FAMILIA SE CONSTRUYE +++ SOMOS LOS
						DE SIEMPRE</span
					>
					<span
						>+++ EL QUE ABANDONA PIERDE +++ NACIDOS EN EL BARRO +++
						UN CÍRCULO QUE NO SE ROMPE +++ MÁS QUE LOS MINUTOS +++
						SUDOR Y GLORIA +++ LA FAMILIA SE CONSTRUYE +++ SOMOS LOS
						DE SIEMPRE</span
					>
				</div>
			</div>
		</div>

		<!-- Match Section -->
		<section class="py-24 px-6 md:px-12 relative z-10">
			<div class="max-w-7xl mx-auto flex flex-col items-center">
				<h2
					class="font-graffiti text-xl md:text-6xl uppercase tracking-[0.2em] mb-12"
				>
					LA FECHA
				</h2>

				<div
					class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 w-full max-w-6xl px-4"
				>
					{
						lastMatch && (
							<MatchCard
								variant="neutral"
								label="Ultimo Resultado"
								team1="LDS FC"
								team2={lastMatch.rival}
								score1={
									lastMatch.result?.split("-")[0].trim() ||
									"0"
								}
								score2={
									lastMatch.result?.split("-")[1].trim() ||
									"0"
								}
								date={lastMatch.date}
								location={lastMatch.place}
								isResult={true}
								rotation="left"
							/>
						)
					}
					{
						nextMatch && (
							<MatchCard
								variant="cyan"
								label="Próximo Partido"
								team1="LDS FC"
								team2={nextMatch.rival}
								date={nextMatch.date}
								time={nextMatch.time}
								location={nextMatch.place}
								rotation="right"
							/>
						)
					}
				</div>

				<div class="mt-12 text-center">
					<a
						href="/partidos"
						class="inline-block px-8 py-3 bg-transparent border border-white/20 text-white font-heading uppercase tracking-widest text-sm hover:bg-white hover:text-black transition-colors"
					>
						Ver más partidos
					</a>
				</div>
			</div>
		</section>
		<QuoteSection />

		<HomeManifesto />

		<HomeSquad players={players} />

		<HomeTraining />

		<HomeCommunity story={featuredStory} />

		<HomeStore products={products} />

		<HomeContact />

		<Footer />
	</main>
</Layout>

<style>
	.animate-fade-in-up {
		animation: fadeInUp 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
		opacity: 0;
		transform: translateY(40px);
	}

	.delay-100 {
		animation-delay: 0.1s;
	}
	.delay-200 {
		animation-delay: 0.2s;
	}
	.delay-300 {
		animation-delay: 0.3s;
	}

	.clip-path-slope {
		clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0% 100%, 0% 20%);
	}

	@keyframes fadeInUp {
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
