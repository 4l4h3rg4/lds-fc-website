---
import Layout from "../layouts/Layout.astro";
import { ArrowRight, Zap, Shield, Globe } from "lucide-react";
import MatchCard from "../components/home/MatchCard.astro";
import QuoteSection from "../components/home/QuoteSection.astro";
import HomeManifesto from "../components/home/HomeManifesto.astro";
import HomeSquad from "../components/home/HomeSquad.astro";
import HomeTraining from "../components/home/HomeTraining.astro";
import HomeCommunity from "../components/home/HomeCommunity.astro";
import HomeStore from "../components/home/HomeStore.astro";
import HomeContact from "../components/home/HomeContact.astro";
import Footer from "../components/shared/Footer.astro";
import { supabase } from "../lib/supabase";

// 1. Fetch Players (Limit 3 for display)
const { data: playersData } = await supabase
	.from("players")
	.select("*")
	.limit(3);
const players = playersData || [];

// 2. Fetch Products (Limit 3, with badges)
const { data: productsData } = await supabase
	.from("products")
	.select("*, badge:badges(text, color)")
	.limit(3);
const products = (productsData || []).map((p: any) => ({
	...p,
	badge: p.badge, // Ensure badge structure matches
}));

// 3. Fetch Featured Story (Limit 1)
const { data: storiesData } = await supabase
	.from("stories")
	.select("*")
	.limit(1);
const featuredStory =
	storiesData && storiesData.length > 0 ? storiesData[0] : null;

// 4. Fetch Matches (Next and Last)
const { data: matchesData } = await supabase
	.from("matches")
	.select(
		`
        *,
        match_players (
            is_starter,
            goals,
            player:players (name)
        )
    `,
	)
	.order("created_at", { ascending: false }); // Assuming created_at helps or parsed date

const allMatches = (matchesData || []).map((m: any) => {
	// Transform match_players logic (same as partidos.astro)
	const starters: any[] = [];
	const bench: any[] = [];
	if (m.match_players) {
		m.match_players.forEach((mp: any) => {
			const playerObj = {
				name: mp.player.name,
				goals: mp.goals > 0 ? mp.goals : undefined,
			};
			if (mp.is_starter) starters.push(playerObj);
			else bench.push(playerObj);
		});
	}
	return { ...m, squad: { starters, bench } };
});

const nextMatch = allMatches.find((m: any) => m.status === "NEXT");
const lastMatch = allMatches.find((m: any) => m.status !== "NEXT"); // Simplification for now
---

<Layout title="LDS FC | El Rugido">
	<main class="w-full relative">
		<!-- Hero Section -->
		<div
			class="relative w-full h-screen flex flex-col justify-center items-center overflow-hidden"
		>
			<!-- Background Image -->
			<div class="absolute inset-0 z-0">
				<img
					src="/bg-hero.png"
					alt="Hero Background"
					class="w-full h-full object-cover opacity-80"
				/>
				<div class="absolute inset-0 bg-black/60"></div>
			</div>

			<!-- Content Z-Index -->
			<div
				class="relative z-10 flex flex-col items-center justify-center -mt-20"
			>
				<!-- Logo -->
				<img
					src="/logo LDS FC.png"
					alt="LDS FC Logo"
					class="h-24 md:h-32 mb-8 drop-shadow-[0_0_15px_rgba(34,211,238,0.3)]"
				/>

				<!-- Main Title with Glow and Sticker -->
				<div class="relative mb-6 text-center">
					<h1
						class="font-graffiti text-[120px] md:text-[180px] leading-[0.8] tracking-normal text-white drop-shadow-[5px_5px_0px_rgba(0,0,0,0.5)] transform -rotate-2 mix-blend-normal opacity-100"
					>
						L.D.S FC
					</h1>
				</div>

				<!-- Subtext with bullets -->
				<div
					class="flex items-center gap-4 text-[var(--color-neon-cyan)] uppercase tracking-[0.5em] md:tracking-[0.8em] font-light text-xs md:text-sm mb-12"
				>
					<span>El que abandona pierde</span>
				</div>

				<!-- Buttons -->
				<div class="flex flex-col md:flex-row gap-6">
					<a
						href="#plantel"
						class="px-8 py-3 bg-white text-black font-heading uppercase tracking-widest text-sm hover:scale-105 transition-transform"
					>
						La Familia
					</a>
					<a
						href="#partidos"
						class="px-8 py-3 bg-black text-white border border-white font-heading uppercase tracking-widest text-sm hover:bg-white hover:text-black transition-colors"
					>
						La Fecha
					</a>
				</div>
			</div>

			<!-- Bottom Banner (Scrolling) -->
			<div
				class="absolute bottom-0 w-full bg-[var(--color-neon-cyan)] text-black py-2 overflow-hidden border-t-2 border-black z-30"
			>
				<div
					class="animate-marquee whitespace-nowrap flex gap-12 font-heading uppercase tracking-widest text-sm font-bold"
				>
					<!-- Content duplicated for seamless loop -->
					<span
						>+++ EL QUE ABANDONA PIERDE +++ NACIDOS EN EL BARRO +++
						UN CÍRCULO QUE NO SE ROMPE +++ MÁS QUE LOS MINUTOS +++
						SUDOR Y GLORIA +++ LA FAMILIA SE CONSTRUYE +++ SOMOS LOS
						DE SIEMPRE</span
					>
					<span
						>+++ EL QUE ABANDONA PIERDE +++ NACIDOS EN EL BARRO +++
						UN CÍRCULO QUE NO SE ROMPE +++ MÁS QUE LOS MINUTOS +++
						SUDOR Y GLORIA +++ LA FAMILIA SE CONSTRUYE +++ SOMOS LOS
						DE SIEMPRE</span
					>
				</div>
			</div>
		</div>

		<!-- Match Section -->
		<section class="py-24 px-6 md:px-12 relative z-10">
			<div class="max-w-7xl mx-auto flex flex-col items-center">
				<h2
					class="font-graffiti text-xl md:text-6xl uppercase tracking-[0.2em] mb-12"
				>
					LA FECHA
				</h2>

				<div
					class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 w-full max-w-6xl px-4"
				>
					{
						lastMatch && (
							<MatchCard
								variant="neutral"
								label="Ultimo Resultado"
								team1="LDS FC"
								team2={lastMatch.rival}
								score1={
									lastMatch.result?.split("-")[0].trim() ||
									"0"
								}
								score2={
									lastMatch.result?.split("-")[1].trim() ||
									"0"
								}
								date={lastMatch.date}
								location={lastMatch.place}
								isResult={true}
								rotation="left"
							/>
						)
					}
					{
						nextMatch && (
							<MatchCard
								variant="cyan"
								label="Próximo Partido"
								team1="LDS FC"
								team2={nextMatch.rival}
								date={nextMatch.date}
								time={nextMatch.time}
								location={nextMatch.place}
								rotation="right"
							/>
						)
					}
				</div>

				<div class="mt-12 text-center">
					<a
						href="/partidos"
						class="inline-block px-8 py-3 bg-transparent border border-white/20 text-white font-heading uppercase tracking-widest text-sm hover:bg-white hover:text-black transition-colors"
					>
						Ver más partidos
					</a>
				</div>
			</div>
		</section>
		<QuoteSection />

		<HomeManifesto />

		<HomeSquad players={players} />

		<HomeTraining />

		<HomeCommunity story={featuredStory} />

		<HomeStore products={products} />

		<HomeContact />

		<!-- PRODUCT DETAIL MODAL -->
		<div
			id="product-modal-home"
			class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 hidden opacity-0 transition-opacity duration-300"
		>
			<div
				class="bg-[#111] border border-white/20 p-6 md:p-8 rounded-sm w-full max-w-4xl relative shadow-[0_0_50px_rgba(34,211,238,0.1)] max-h-[90vh] overflow-y-auto flex flex-col md:flex-row gap-8"
			>
				<button
					id="close-modal-home"
					class="absolute top-4 right-4 text-neutral-500 hover:text-white transition-colors z-10"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="24"
						height="24"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
						><path d="M18 6 6 18"></path><path d="m6 6 12 12"
						></path></svg
					>
				</button>

				<!-- Modal Image -->
				<div
					class="w-full md:w-1/2 bg-[#050505] flex items-center justify-center border border-white/5 relative aspect-square md:aspect-auto"
				>
					<img
						id="modal-image-home"
						src=""
						alt=""
						class="w-full h-full object-cover hidden"
					/>
					<div id="modal-placeholder-home" class="text-white/20">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="64"
							height="64"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="1"
							stroke-linecap="round"
							stroke-linejoin="round"
							><path
								d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"
							></path><line x1="3" x2="21" y1="6" y2="6"
							></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg
						>
					</div>
				</div>

				<!-- Modal Info -->
				<div class="w-full md:w-1/2 flex flex-col">
					<h2
						id="modal-title-home"
						class="font-heading text-3xl md:text-4xl text-white uppercase mb-4 leading-none"
					>
					</h2>
					<div class="flex items-center gap-4 mb-6">
						<span
							id="modal-price-home"
							class="font-heading text-2xl text-[var(--color-neon-cyan)]"
						></span>
						<span
							id="modal-badge-home"
							class="font-mono text-xs font-bold uppercase tracking-wider px-2 py-1 hidden"
						></span>
					</div>

					<div
						class="prose prose-invert prose-sm mb-8 flex-1 overflow-y-auto pr-2 max-h-[40vh]"
					>
						<p
							id="modal-description-home"
							class="font-mono text-neutral-400 whitespace-pre-wrap"
						>
						</p>
					</div>

					<div
						class="mt-auto pt-6 border-t border-white/5 sticky bottom-0 bg-[#111]"
					>
						<button
							id="modal-buy-button-home"
							class="w-full bg-white text-black font-heading uppercase text-sm px-6 py-4 hover:bg-[var(--color-neon-cyan)] transition-colors tracking-wide flex items-center justify-center gap-2"
						>
							LO QUIERO
						</button>
					</div>
				</div>
			</div>
		</div>

		<Footer />
	</main>
</Layout>

<script
	type="application/json"
	id="products-data-home"
	set:html={JSON.stringify(products)}
/>

<script>
	// WhatsApp Phone Number
	const PHONE_NUMBER = "56939268844";

	// Data injection from server
	const productsDataElement = document.getElementById("products-data-home");
	if (!productsDataElement) throw new Error("Products data not found");
	const productsData = JSON.parse(productsDataElement.textContent || "[]");

	// DOM Elements
	const modal = document.getElementById("product-modal-home");
	const closeModal = document.getElementById("close-modal-home");
	const modalImage = document.getElementById(
		"modal-image-home",
	) as HTMLImageElement;
	const modalPlaceholder = document.getElementById("modal-placeholder-home");
	const modalTitle = document.getElementById("modal-title-home");
	const modalPrice = document.getElementById("modal-price-home");
	const modalBadge = document.getElementById("modal-badge-home");
	const modalDescription = document.getElementById("modal-description-home");
	const modalBuyButton = document.getElementById("modal-buy-button-home");
	const productCards = document.querySelectorAll(".home-product-card");

	let currentProduct: any = null;

	// Functions
	function openModal(product: any) {
		currentProduct = product;

		// Populate Data
		if (modalTitle) modalTitle.textContent = product.title;
		if (modalPrice) modalPrice.textContent = product.price;
		if (modalDescription)
			modalDescription.textContent = product.description;

		if (product.image) {
			if (modalImage) modalImage.src = product.image;
			modalImage?.classList.remove("hidden");
			modalPlaceholder?.classList.add("hidden");
		} else {
			modalImage?.classList.add("hidden");
			modalPlaceholder?.classList.remove("hidden");
		}

		if (product.badge && modalBadge) {
			modalBadge.textContent = product.badge.text;
			modalBadge.className = `font-mono text-xs font-bold uppercase tracking-wider px-2 py-1 ${product.badge.color}`;
			modalBadge.classList.remove("hidden");
		} else {
			modalBadge?.classList.add("hidden");
		}

		// Show Modal
		modal?.classList.remove("hidden");
		setTimeout(() => {
			modal?.classList.remove("opacity-0");
		}, 10);
		document.body.style.overflow = "hidden";
	}

	function closeModalHandler() {
		modal?.classList.add("opacity-0");
		setTimeout(() => {
			modal?.classList.add("hidden");
		}, 300);
		document.body.style.overflow = "";
		currentProduct = null;
	}

	function handleBuy() {
		if (!currentProduct) return;

		const message = `¡Hola! Estuve viendo la pagina web y me interesa comprar el producto: *${currentProduct.title}* (${currentProduct.price}). ¿Tienen stock?`;
		const encodedMessage = encodeURIComponent(message);
		const whatsappUrl = `https://wa.me/${PHONE_NUMBER}?text=${encodedMessage}`;
		window.open(whatsappUrl, "_blank");
	}

	// Event Listeners
	productCards.forEach((card) => {
		card.addEventListener("click", (e) => {
			if ((e.target as HTMLElement).closest(".buy-button")) return;

			const id = card.getAttribute("data-id");
			const product = productsData.find((p: any) => p.id == id);
			if (product) openModal(product);
		});
	});

	closeModal?.addEventListener("click", closeModalHandler);
	modal?.addEventListener("click", (e) => {
		if (e.target === modal) closeModalHandler();
	});
	modalBuyButton?.addEventListener("click", handleBuy);

	// Escape key
	document.addEventListener("keydown", (e) => {
		if (e.key === "Escape" && !modal?.classList.contains("hidden")) {
			closeModalHandler();
		}
	});
</script>

<style>
	.animate-fade-in-up {
		animation: fadeInUp 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
		opacity: 0;
		transform: translateY(40px);
	}

	.delay-100 {
		animation-delay: 0.1s;
	}
	.delay-200 {
		animation-delay: 0.2s;
	}
	.delay-300 {
		animation-delay: 0.3s;
	}

	.clip-path-slope {
		clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0% 100%, 0% 20%);
	}

	@keyframes fadeInUp {
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
