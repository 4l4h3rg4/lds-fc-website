---
import Layout from "../layouts/Layout.astro";
import { Calendar, MapPin, Clock, ChevronDown } from "lucide-react";

interface Player {
    name: string;
    goals?: number;
}

import { supabase } from "../lib/supabase";

interface Player {
    name: string;
    goals?: number;
}

interface Match {
    id: string;
    type: string;
    date: string;
    displayDate?: string;
    time: string;
    rival: string;
    place: string;
    result: string | null;
    status: "NEXT" | "WON" | "DRAW" | "LOST";
    squad: {
        starters: Player[];
        bench: Player[];
    };
}

const { data: matchesData, error } = await supabase.from("matches").select(
    `
        *,
        match_players (
            is_starter,
            goals,
            player:players (name)
        )
    `,
);

const formatMatchDate = (dateStr: string) => {
    if (!dateStr) return "";
    // Check if YYYY-MM-DD
    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const [year, month, day] = dateStr.split("-");
        return `${day}/${month}`;
    }
    return dateStr;
};

const rawMatches = (matchesData || []).map((m: any) => {
    // Transform match_players into starters and bench
    const starters: Player[] = [];
    const bench: Player[] = [];

    if (m.match_players) {
        m.match_players.forEach((mp: any) => {
            const playerObj = {
                name: mp.player.name,
                goals: mp.goals > 0 ? mp.goals : undefined,
            };

            if (mp.is_starter) {
                starters.push(playerObj);
            } else {
                bench.push(playerObj);
            }
        });
    }

    return {
        id: m.id,
        type: m.type,
        date: m.date, // Keep raw for sorting
        displayDate: formatMatchDate(m.date), // Formatted for UI
        time: m.time,
        rival: m.rival,
        place: m.place,
        result: m.result,
        status: m.status as "NEXT" | "WON" | "DRAW" | "LOST",
        squad: {
            starters,
            bench,
        },
    };
});

// Sort matches
const matches: Match[] = rawMatches.sort((a, b) => {
    // 1. Priority: NEXT status first
    if (a.status === "NEXT" && b.status !== "NEXT") return -1;
    if (a.status !== "NEXT" && b.status === "NEXT") return 1;

    // 2. Secondary Sort: Date
    const dateA = new Date(`${a.date}T${a.time || "00:00"}`);
    const dateB = new Date(`${b.date}T${b.time || "00:00"}`);

    // If invalid dates (legacy data might be DD/MM), fallback to string comparison
    if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) {
        return b.date.localeCompare(a.date);
    }

    if (a.status === "NEXT") {
        // For upcoming matches, ascending (soonest first)
        return dateA.getTime() - dateB.getTime();
    } else {
        // For past matches, descending (newest first)
        return dateB.getTime() - dateA.getTime();
    }
});
---

<Layout title="LDS FC | Partidos">
    <main class="max-w-5xl mx-auto px-6 pt-32 pb-20">
        <h1
            class="font-graffiti text-6xl md:text-8xl text-white uppercase mb-16"
        >
            Partidos
        </h1>

        <div class="space-y-6">
            {
                matches.map((m) => (
                    <div
                        class={`match-card group relative border ${m.status === "NEXT" ? "border-[var(--color-neon-cyan)] bg-[var(--color-neon-cyan)]/5" : "border-white/10 bg-white/5"} overflow-hidden transition-all hover:border-[var(--color-neon-cyan)]/50 cursor-pointer`}
                        data-match-id={m.id}
                    >
                        {/* Header Content */}
                        <div class="p-6 md:p-8 flex flex-col md:flex-row items-start md:items-center justify-between gap-6 relative z-10">
                            {/* Status Strip */}
                            <div
                                class={`absolute left-0 top-0 bottom-0 w-1 ${
                                    m.status === "NEXT"
                                        ? "bg-[var(--color-neon-cyan)]"
                                        : m.status === "WON"
                                          ? "bg-green-500"
                                          : m.status === "LOST"
                                            ? "bg-red-500"
                                            : "bg-neutral-500"
                                }`}
                            />

                            <div class="flex flex-col md:flex-row gap-6 md:items-center min-w-[200px]">
                                <div class="text-center md:text-left">
                                    <span class="block font-heading text-3xl md:text-4xl text-white">
                                        {m.displayDate}
                                    </span>
                                    <span class="block font-mono text-sm text-neutral-500">
                                        {m.type}
                                    </span>
                                </div>
                                <div class="hidden md:block h-10 w-px bg-white/10" />
                                <div class="flex items-center gap-2 text-neutral-400">
                                    <Clock size={16} />
                                    <span class="font-mono text-sm">
                                        {m.time} HS
                                    </span>
                                </div>
                            </div>

                            <div class="flex-1 flex flex-col md:flex-row items-start md:items-center justify-center gap-4 w-full">
                                <span class="font-heading text-2xl md:text-3xl text-white">
                                    LDS FC
                                </span>
                                <span class="font-mono text-xl text-neutral-600">
                                    VS
                                </span>
                                <span class="font-heading text-2xl md:text-3xl text-neutral-300">
                                    {m.rival}
                                </span>
                            </div>

                            <div class="flex flex-col items-end min-w-[150px]">
                                {m.result ? (
                                    <span class="font-heading text-4xl text-[var(--color-neon-cyan)]">
                                        {m.result}
                                    </span>
                                ) : (
                                    <span class="font-heading text-xl text-white bg-[var(--color-neon-cyan)]/20 px-3 py-1 rounded-sm border border-[var(--color-neon-cyan)]/30 animate-pulse">
                                        PRÓXIMO
                                    </span>
                                )}
                                <div class="flex items-center gap-1 mt-2 text-neutral-500">
                                    <MapPin size={12} />
                                    <span class="text-[10px] uppercase">
                                        {m.place}
                                    </span>
                                </div>
                            </div>

                            <div class="absolute right-4 bottom-4 md:static md:ml-4 text-white/20 group-hover:text-[var(--color-neon-cyan)] transition-colors">
                                <ChevronDown className="transform transition-transform duration-300 chevron-icon" />
                            </div>
                        </div>

                        {/* Details Section (Hidden by default) */}
                        <div class="match-details grid grid-rows-[0fr] transition-[grid-template-rows] duration-500 ease-out border-t border-white/5 bg-black/20">
                            <div class="overflow-hidden">
                                <div class="p-6 md:p-8 flex flex-col md:flex-row gap-12">
                                    {/* Starters */}
                                    <div class="flex-1">
                                        <h3 class="font-mono text-[var(--color-neon-cyan)] text-sm tracking-widest uppercase mb-4 opacity-80">
                                            Titulares
                                        </h3>
                                        <ul class="space-y-2">
                                            {m.squad.starters.map((player) => (
                                                <li class="flex items-center justify-between text-white border-b border-white/5 pb-2 last:border-0">
                                                    <span class="font-heading text-xl uppercase tracking-wide">
                                                        {player.name}
                                                    </span>
                                                    {player.goals && (
                                                        <span class="flex items-center gap-1 text-[var(--color-neon-cyan)] font-mono text-sm">
                                                            ⚽ x{player.goals}
                                                        </span>
                                                    )}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>

                                    {/* Bench */}
                                    <div class="flex-1">
                                        <h3 class="font-mono text-neutral-500 text-sm tracking-widest uppercase mb-4">
                                            Banca
                                        </h3>
                                        <ul class="space-y-2">
                                            {m.squad.bench.map((player) => (
                                                <li class="flex items-center justify-between text-neutral-400 border-b border-white/5 pb-2 last:border-0">
                                                    <span class="font-heading text-xl uppercase tracking-wide">
                                                        {player.name}
                                                    </span>
                                                    {player.goals && (
                                                        <span class="flex items-center gap-1 text-[var(--color-neon-cyan)] font-mono text-sm">
                                                            ⚽ x{player.goals}
                                                        </span>
                                                    )}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>
    </main>

    <script>
        document.addEventListener("astro:page-load", () => {
            setupMatches();
        });

        setupMatches();

        function setupMatches() {
            const cards = document.querySelectorAll(".match-card");
            cards.forEach((card) => {
                card.addEventListener("click", () => {
                    const details = card.querySelector(".match-details");
                    const icon = card.querySelector(".chevron-icon");

                    // Close other open cards (optional, for accordion style)
                    // cards.forEach(c => {
                    //     if(c !== card) {
                    //         c.querySelector('.match-details')?.classList.remove('grid-rows-[1fr]');
                    //         c.querySelector('.match-details')?.classList.add('grid-rows-[0fr]');
                    //         c.querySelector('.chevron-icon')?.classList.remove('rotate-180');
                    //     }
                    // });

                    if (details?.classList.contains("grid-rows-[0fr]")) {
                        details.classList.remove("grid-rows-[0fr]");
                        details.classList.add("grid-rows-[1fr]");
                        icon?.classList.add("rotate-180");
                    } else {
                        details?.classList.add("grid-rows-[0fr]");
                        details?.classList.remove("grid-rows-[1fr]");
                        icon?.classList.remove("rotate-180");
                    }
                });
            });
        }
    </script>
</Layout>
